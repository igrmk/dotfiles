# Uncomment to profile the loading of .zshrc
# zmodload zsh/zprof

export PATH="$HOME/.local/bin:$PATH"
export PATH="$HOME/go/bin:$PATH"
export PATH="$HOME/.cargo/bin:$PATH"

export ZPLUG_HOME="$HOME/.zplug"

for file in ~/.source.d/*; do
	[[ -f "$file" && -r "$file" ]] && source "$file"
done

# This must precede "zplug load", otherwise CAVEZ cannot initialise a newly opened tab.
# The export below is for reference; it actually coincides with the default:
# https://mamba.readthedocs.io/en/latest/installation/micromamba-installation.html
export MAMBA_ROOT_PREFIX="$HOME/micromamba"
export CAVEZ_CONDA_FLAVOUR=micromamba

if command -v micromamba >/dev/null 2>&1; then
	eval "$(micromamba shell hook --shell=zsh)"
fi

zplug romkatv/powerlevel10k, as:theme, depth:1
zplug igrmk/cavez

if ! zplug check --verbose; then
	printf "Install? [y/N]: "
	if read -q; then
		echo; zplug install
	fi
fi

zplug load

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
	source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

export ZSH_THEME="powerlevel10k/powerlevel10k"
export CASE_SENSITIVE="true"
export HYPHEN_INSENSITIVE="false"
export BRIGHT=$(cat ~/.bright)
export PAGER='less -SFXR'

export CAVEZ_VERBOSE="false"
export DISABLE_MAGIC_FUNCTIONS="false"
export DISABLE_LS_COLORS="false"
export DISABLE_AUTO_TITLE="false"
export ENABLE_CORRECTION="false"
export COMPLETION_WAITING_DOTS="false"
export DISABLE_UNTRACKED_FILES_DIRTY="false"
export HISTFILE="$HOME/.zsh_history"
export HIST_STAMPS="yyyy-mm-dd"
export HISTSIZE=100000
export SAVEHIST=100000
export HOMEBREW_AUTO_UPDATE_SECS=86400
export CLOUDSDK_PYTHON=python3.12
export DFT_BACKGROUND=light

zstyle ':omz:update' mode auto
zstyle ':omz:update' frequency 13
zstyle ':chpwd:*' recent-dirs-max 100
zstyle ':completion:*:*:cdr:*:*' menu selection

zmodload zsh/complist
bindkey -M menuselect 'h' vi-backward-char
bindkey -M menuselect 'k' vi-up-line-or-history
bindkey -M menuselect 'l' vi-forward-char
bindkey -M menuselect 'j' vi-down-line-or-history
_comp_options+=(globdots)
autoload -U compinit; compinit
export EDITOR='vim'

eval "$(zoxide init zsh)"

autoload -U up-line-or-beginning-search
autoload -U down-line-or-beginning-search
zle -N up-line-or-beginning-search
zle -N down-line-or-beginning-search
bindkey -v
bindkey '^k' up-line-or-beginning-search
bindkey '^j' down-line-or-beginning-search
bindkey -M vicmd 'k' up-line-or-beginning-search
bindkey -M vicmd 'j' down-line-or-beginning-search
bindkey -M viins '^?' backward-delete-char
export KEYTIMEOUT=1

if [ -f "$HOME/google-cloud-sdk/path.zsh.inc" ]; then . "$HOME/google-cloud-sdk/path.zsh.inc"; fi
if [ -f "$HOME/google-cloud-sdk/completion.zsh.inc" ]; then . "$HOME/google-cloud-sdk/completion.zsh.inc"; fi

# fzf setup with custom vim mode bindings
if [[ -f ~/.fzf.zsh ]]; then
	source ~/.fzf.zsh
	# Remove default Alt-C binding
	bindkey -r -M emacs '\ec'
	bindkey -r -M vicmd '\ec'
	bindkey -r -M viins '\ec'
	# Custom bindings (vim mode)
	bindkey -M viins '^T' fzf-file-widget
	bindkey -M vicmd '^T' fzf-file-widget
	bindkey -M viins '^F' fzf-cd-widget
	bindkey -M vicmd '^F' fzf-cd-widget
	bindkey -M viins '^R' fzf-history-widget
	bindkey -M vicmd '^R' fzf-history-widget
fi

autoload -Uz chpwd_recent_dirs cdr add-zsh-hook
add-zsh-hook chpwd chpwd_recent_dirs
# TODO: uncomment it when these mother fuckers make it fast again
# eval "$(gh copilot alias -- zsh)"

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

setopt AUTO_PUSHD
setopt PUSHD_IGNORE_DUPS
setopt PUSHD_SILENT
setopt APPEND_HISTORY
setopt SHARE_HISTORY
setopt HIST_IGNORE_SPACE

FNM_PATH="$HOME/.fnm"
if command -v fnm >/dev/null 2>&1; then
	eval "$(fnm env --use-on-cd --shell zsh)"
fi

# Uncomment to profile the loading of .zshrc
# zprof
